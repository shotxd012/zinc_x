<div
  x-data="{
  plugins: [],
  loading: true,
  installingPlugin: null,
  unInstallingPlugin: null,
  togglingPlugins: new Set(),
  updatingPlugins: new Set(),

  isToggling(pluginName) {
    return this.togglingPlugins.has(pluginName);
  },
  isUpdating(pluginName) {
    return this.updatingPlugins.has(pluginName);
  },
  async init() {
    try {
      const response = await fetch('/admin/plugins');
      this.plugins = await response.json();
    } catch (error) {
      console.error('Failed to load plugins:', error);
    } finally {
      this.loading = false;
    }
  },
  async togglePlugin(plugin) {
    if (this.isToggling(plugin.name)) return;
    this.togglingPlugins.add(plugin.name);
    try {
      const action = plugin.enabled ? 'disable' : 'enable';
      const response = await fetch('/admin/plugins', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pluginName: plugin.name, action: action })
      });
      if (response.ok) {
        plugin.enabled = !plugin.enabled;
        Alpine.store('toast').show(`Plugin ${plugin.name} ${action}d successfully`, 'success');
      } else {
        throw new Error(`Failed to ${action} plugin`);
      }
    } catch (error) {
      Alpine.store('toast').show(`Failed to ${plugin.enabled ? 'disable' : 'enable'} plugin`, 'error');
    } finally {
      this.togglingPlugins.delete(plugin.name);
    }
  },
  async installPlugin(plugin) {
    if (this.installingPlugin) return;
    this.installingPlugin = plugin.name;
    try {
      const response = await fetch('/admin/plugins', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pluginName: plugin.name, action: 'install' })
      });
      if (response.ok) {
        plugin.installed = true;
        Alpine.store('toast').show(`Plugin ${plugin.name} installed successfully`, 'success');
      }
    } catch (error) {
      Alpine.store('toast').show('Failed to install plugin', 'error');
    } finally {
      this.installingPlugin = null;
    }
  },
  async uninstallPlugin(plugin) {
    if (this.unInstallingPlugin) return;
    this.unInstallingPlugin = plugin.name;
    try {
      const response = await fetch('/admin/plugins', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pluginName: plugin.name, action: 'uninstall' })
      });
      if (response.ok) {
        plugin.installed = false;
        plugin.enabled = false;
        Alpine.store('toast').show(`Plugin ${plugin.name} uninstalled successfully`, 'success');
      }
    } catch (error) {
      Alpine.store('toast').show('Failed to uninstall plugin', 'error');
    } finally {
      this.unInstallingPlugin = null;
    }
  },
  async updatePlugin(plugin) {
    if (this.isUpdating(plugin.name)) return;
    this.updatingPlugins.add(plugin.name);
    try {
      const response = await fetch('/admin/plugins', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pluginName: plugin.name, action: 'update' })
      });
      if (response.ok) {
        plugin.currentVersion = plugin.version;
        plugin.hasUpdate = false;
        Alpine.store('toast').show(`Plugin ${plugin.name} updated successfully`, 'success');
      }
    } catch (error) {
      Alpine.store('toast').show('Failed to update plugin', 'error');
    } finally {
      this.updatingPlugins.delete(plugin.name);
    }
  },
  searchTerm: '',
  get filteredPlugins() {
    if (!this.searchTerm) return this.plugins;
    const term = this.searchTerm.toLowerCase();
    return this.plugins.filter(plugin => 
      plugin.name.toLowerCase().includes(term) || 
      (plugin.description && plugin.description.toLowerCase().includes(term)) ||
      (plugin.author && plugin.author.toLowerCase().includes(term))
    );
  },
  get installedPluginsCount() {
    return this.plugins.filter(p => p.installed).length;
  }
}">
  <section class="mb-6">
    <div class="border-border bg-bg-panel flex items-center justify-between rounded-lg border p-4 shadow-sm">
      <div>
        <h2 class="text-text text-lg font-semibold"><%= tr("ADMIN_PAGE.PLUGINS") %></h2>
        <p class="text-text-muted text-sm"><%= tr("ADMIN_PAGE.DESCRIPTION") %></p>
      </div>
      <div class="flex items-center space-x-4">
        <span
          class="text-text-muted text-sm"
          x-text="'<%=tr(`ADMIN_PAGE.INSTALLED`)%>: ' + installedPluginsCount + ' / <%=tr(`ADMIN_PAGE.TOTAL`)%>: ' + plugins.length">
        </span>
      </div>
    </div>
  </section>

  <!-- Search Bar -->
  <div class="mb-6">
    <div class="relative">
      <input
        type="text"
        x-model="searchTerm"
        placeholder="Search plugins..."
        class="focus:border-primary border-border bg-bg-interactive text-text w-full rounded-lg border py-2 pl-10 pr-4 focus:outline-none" />
      <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
        <svg class="text-text-muted h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
            clip-rule="evenodd" />
        </svg>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div x-show="loading" class="py-8 text-center">
    <div class="border-primary inline-block h-8 w-8 animate-spin rounded-full border-4 border-t-transparent"></div>
    <p class="text-text-muted mt-2"><%=tr("ADMIN_PAGE.LOADING")%></p>
  </div>

  <!-- Plugins Grid -->
  <div x-show="!loading" class="grid gap-6" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))">
    <template x-for="plugin in filteredPlugins" :key="plugin.name">
      <div
        class="border-border bg-bg-panel flex h-full min-w-[240px] flex-col justify-between rounded-2xl border p-6 shadow-md transition-shadow hover:shadow-lg">
        <div>
          <div class="mb-2 flex items-start justify-between">
            <h3 class="text-text flex items-center text-lg font-bold tracking-tight">
              <i class="fas fa-puzzle-piece text-text-muted mr-2"></i>
              <!-- Added Font Awesome icon -->
              <span x-text="plugin.name"></span>
            </h3>
            <span
              x-show="plugin.installed && plugin.name !== 'core'"
              :class="[
                plugin.enabled ? 'bg-success-dark text-white' : 'bg-border text-text-muted',
                (isToggling(plugin.name) || installingPlugin === plugin.name || unInstallingPlugin === plugin.name) ? 'opacity-60 pointer-events-none' : 'cursor-pointer hover:opacity-80 transition'
              ]"
              class="ml-2 flex min-w-[70px] items-center justify-center rounded-full border border-transparent px-2 py-0.5 text-xs font-semibold"
              @click="!(isToggling(plugin.name) || installingPlugin === plugin.name || unInstallingPlugin === plugin.name) && togglePlugin(plugin)">
              <i class="fa-solid fa-spinner fa-spin mr-1" x-show="isToggling(plugin.name)"></i>
              <span x-text="plugin.enabled ? 'Enabled' : 'Disabled'"></span>
            </span>
          </div>
          <div class="text-text-muted mb-1 flex items-center justify-between text-sm">
            <span> by <span x-text="plugin.author || 'Unknown'"></span> </span>
            <span class="font-mono text-xs" x-text="'v' + (plugin.installed ? plugin.currentVersion : plugin.version)"></span>
          </div>
          <p class="text-text-muted mb-3 text-sm" x-text="plugin.description"></p>
          <template x-if="plugin.repository">
            <a
              :href="plugin.repository + (plugin.repositoryPath ? '/tree/main/' + plugin.repositoryPath : '')"
              target="_blank"
              class="text-primary-light inline-flex items-center gap-1 text-sm font-medium hover:underline">
              <i class="fa-brands fa-github"></i>
              <%=tr("ADMIN_PAGE.VIEW_SOURCE")%>
            </a>
          </template>
        </div>
        <div class="border-border mt-4 flex justify-end border-t pt-4">
          <button
            x-show="plugin.installed && plugin.name !== 'core'"
            @click="uninstallPlugin(plugin)"
            :disabled="(unInstallingPlugin && unInstallingPlugin !== plugin.name) || plugin.enabled"
            class="bg-error-dark hover:bg-error-dark min-w-[80px] rounded-md px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition-colors disabled:cursor-not-allowed disabled:opacity-50">
            <span x-show="unInstallingPlugin === plugin.name"><%=tr("ADMIN_PAGE.UNINSTALLING")%></span>
            <span x-show="unInstallingPlugin !== plugin.name" x-text="'<%=tr(`ADMIN_PAGE.UNINSTALL`)%>'"></span>
          </button>
          <button
            x-show="!plugin.installed && plugin.name !== 'core'"
            @click="installPlugin(plugin)"
            :disabled="installingPlugin && installingPlugin !== plugin.name"
            class="bg-primary hover:bg-primary-dark min-w-[80px] rounded-md px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition-colors disabled:cursor-not-allowed disabled:opacity-50">
            <span x-show="installingPlugin === plugin.name"><%=tr("ADMIN_PAGE.INSTALLING")%></span>
            <span x-show="installingPlugin !== plugin.name" x-text="'<%=tr(`ADMIN_PAGE.INSTALL`)%>'"></span>
          </button>
        </div>
      </div>
    </template>
  </div>

  <!-- Empty State -->
  <div x-show="!loading && filteredPlugins.length === 0" class="py-8 text-center">
    <p class="text-text-muted"><%=tr("ADMIN_PAGE.NO_MATCH")%></p>
  </div>
</div>
